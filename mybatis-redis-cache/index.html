<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
<title>SpringBoot——Mybatis配置Redis二级缓存 - 小丁的blog</title>
<meta name="description" content="&lt;div&gt;&lt;span&gt;在技术的道路上慢慢找寻自我的价值&lt;/span&gt;
                                             &lt;span class=&#34;rt&#34;&gt;  ———小丁 
   &lt;/span&gt;&lt;/div&gt;">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link type='text/css' rel='stylesheet' href='https://maodou38.github.io/styles/main.css' media='screen' />
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css">
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">

<script type="text/javascript" src='https://maodou38.github.io/media/scripts/jquery.js'></script>
<script type="text/javascript" src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>

<script>
    hljs.initHighlightingOnLoad();
</script>
</head>

<body>
  <div class="layout theme-dark">
    <div class="layout-header">

	<div class="layout-header-main">
		<div class="container">
			<div class="row justify-content-lg-center">
				<div class="col-12 col-lg-9">

					<div class="navbar">

						<div class="logo">
							<a href="https://maodou38.github.io">
								<img class="logo"
									src="https://maodou38.github.io/media/images/site_avatar.png?v=1591968940606"
									alt="">
							</a>
						</div>

						<div class="menu d-md-inline-block d-none">
							<ul class="layout-navigation-list">
								
								<li class="layout-navigation-item"><a title="主页"
										href="https://maodou38.github.io">主页</a>
								</li>
								
								<li class="layout-navigation-item"><a title="标签"
										href="https://maodou38.github.io/tags">标签</a>
								</li>
								
								<li class="layout-navigation-item"><a title="归档"
										href="https://maodou38.github.io/archives">归档</a>
								</li>
								
							</ul>
						</div>

						<div class="item d-md-inline-block d-none">
							<div class="search-icon">
								<i class="fa fa-search" aria-hidden="true"></i>
							</div>
						</div>



						<div class="d-md-inline-block d-none">
							<div class="search-lightbox">
								<div class="search-body">

									<form id="gridea-search-form" data-update="1591968940606" action="/search/" class="search-form">
										<input type="text" name="q" id="s" value="" class="search-field" placeholder="请输入搜索关键词" aria-label="请输入搜索关键词" required="">
										<button type="submit" class="submit" aria-label="Submit">
											<i class="fa fa-search" aria-hidden="true"></i>
										</button>
									</form>

								</div>
							</div>
						</div>

						<div class="nav d-md-none d-inline-block">
							<div class="trigger">
								<i class="fa fa-bars layout-btn-toggle" aria-hidden="true"></i>
							</div>
						</div>

					</div>

				</div>
			</div>




		</div>
	</div>

</div>
    <div class="layout-collapse d-md-none">
	<div class="layout-collapse-main">
		<ul class="layout-collapse-list">
			
			<li class="layout-collapse-item"><a title="主页" href="https://maodou38.github.io">主页</a></li>
			
			<li class="layout-collapse-item"><a title="标签" href="https://maodou38.github.io/tags">标签</a></li>
			
			<li class="layout-collapse-item"><a title="归档" href="https://maodou38.github.io/archives">归档</a></li>
			

		</ul>
	</div>
</div>

    <div class="layout-content">
      <div class="layout-content-main">
        <div class="container">
          <div class="row justify-content-lg-center">
            <div class="col-12 col-lg-9">
              <div class="layout-post">
                <div class="layout-post-body">
                  <div class="row">

                    <div class="col-12 col-lg-10">
                      <div class="layout-post-main m-right m-md-right">
                        <div class="layout-post-header">
                          <h1 class="layout-post-title">SpringBoot——Mybatis配置Redis二级缓存</h1>
                          <div class="layout-post-meta">
                            <div class="item">
                               <a href="https://maodou38.github.io/bk1AeQmzB/" class="post--keyword"
                                data-title="springboot" data-type="post_tag" data-term-id="39">springboot</a>
                               <a href="https://maodou38.github.io/rEjH4-Bi46/" class="post--keyword"
                                data-title="Java" data-type="post_tag" data-term-id="39">Java</a>
                              
                            </div>
                            <div class="item">
                              <span>2020-03-27</span>
                            </div>
                          </div>
                        </div>
                        <div class="layout-post-content">
                          <div class="layout-post-item">
                            
                            <h1 id="一级缓存">一级缓存</h1>
<p>MyBatis 会在表示会话的 SqlSession 对象中建立一个简单的缓存，将每次查询到的结果结果缓存起来，当下次查询的时候，如果判断先前有个完全一样的查询，会直接从缓存中直接将结果取出，返回给用户，不需要再进行一次数据库查询了。</p>
<p>一级缓存是 SqlSession 级别的缓存。在操作数据库时需要构造 sqlSession 对象，在对象中有一个（内存区域）数据结构（HashMap）用于存储缓存数据。不同的 sqlSession 之间的缓存数据区域（HashMap）是互相不影响的。其作用域是同一个 SqlSession，在同一个 sqlSession 中两次执行相同的 sql 语句，第一次执行完毕会将数据库中查询的数据写到缓存（内存），第二次会从缓存中获取数据将不再从数据库查询，从而提高查询效率。当一个 sqlSession 结束后该 sqlSession 中的一级缓存也就不存在了。Mybatis 默认开启一级缓存。</p>
<h1 id="二级缓存">二级缓存</h1>
<p>二级缓存是 mapper 级别的缓存，多个 SqlSession 去操作同一个 Mapper 的 sql 语句，多个 SqlSession 去操作数据库得到数据会存在二级缓存区域，多个 SqlSession 可以共用二级缓存，二级缓存是跨 SqlSession 的。其作用域是 mapper 的同一个 namespace，不同的 sqlSession 两次执行相同 namespace下的 sql 语句且向 sql 中传递参数也相同即最终执行相同的 sql 语句，第一次执行完毕会将数据库中查询的数据写到缓存（内存），第二次会从缓存中获取数据将不再从数据库查询，从而提高查询效率。Mybatis 默认没有开启二级缓存需要在 setting 全局参数中配置开启二级缓存。</p>
<h1 id="开启-mybatis-二级缓存">开启 MyBatis 二级缓存</h1>
<p>在 Spring Boot 配置文件中开启 MyBatis 二级缓存，配置代码如下：</p>
<pre><code>mybatis:
  configuration:
    cache-enabled: true
</code></pre>
<h1 id="实体类实现序列化接口并声明序列号">实体类实现序列化接口并声明序列号</h1>
<p>private static final long serialVersionUID = 8289770415244673535L;</p>
<h1 id="idea-提示生成序列号">IDEA 提示生成序列号</h1>
<p>默认情况下 Intellij IDEA 不会提示继承了 Serializable 接口的类生成 serialVersionUID 的警告。如果需要生成 serialVersionUID，需要手动配置。<br>
File -&gt; Settings -&gt; Inspections -&gt; Serialization issues -&gt; Serialization class without 'serialVersionUID'<br>
<img src="https://maodou38.github.io/post-images/1585299053580.png" alt="" loading="lazy"></p>
<h1 id="创建相关工具类">创建相关工具类</h1>
<h2 id="实现-spring-applicationcontextaware-接口用于手动注入-bean">实现 Spring ApplicationContextAware 接口，用于手动注入 Bean</h2>
<p>创建一个名为 ApplicationContextHolder 的工具类，代码如下：</p>
<pre><code>import org.apache.commons.lang3.Validate;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.DisposableBean;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.stereotype.Component;

@Component
public class ApplicationContextHolder implements ApplicationContextAware, DisposableBean {
    private static final Logger logger = LoggerFactory.getLogger(ApplicationContextHolder.class);

    private static ApplicationContext applicationContext;

    /**
     * 获取存储在静态变量中的 ApplicationContext
     *
     * @return
     */
    public static ApplicationContext getApplicationContext() {
        assertContextInjected();
        return applicationContext;
    }

    /**
     * 从静态变量 applicationContext 中获取 Bean，自动转型成所赋值对象的类型
     *
     * @param name
     * @param &lt;T&gt;
     * @return
     */
    public static &lt;T&gt; T getBean(String name) {
        assertContextInjected();
        return (T) applicationContext.getBean(name);
    }

    /**
     * 从静态变量 applicationContext 中获取 Bean，自动转型成所赋值对象的类型
     *
     * @param clazz
     * @param &lt;T&gt;
     * @return
     */
    public static &lt;T&gt; T getBean(Class&lt;T&gt; clazz) {
        assertContextInjected();
        return applicationContext.getBean(clazz);
    }

    /**
     * 实现 DisposableBean 接口，在 Context 关闭时清理静态变量
     *
     * @throws Exception
     */
    public void destroy() throws Exception {
        logger.debug(&quot;清除 SpringContext 中的 ApplicationContext: {}&quot;, applicationContext);
        applicationContext = null;
    }

    /**
     * 实现 ApplicationContextAware 接口，注入 Context 到静态变量中
     *
     * @param applicationContext
     * @throws BeansException
     */
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        ApplicationContextHolder.applicationContext = applicationContext;
    }

    /**
     * 断言 Context 已经注入
     */
    private static void assertContextInjected() {
        Validate.validState(applicationContext != null, &quot;applicationContext 属性未注入，请在 spring-context.xml 配置中定义 ApplicationContextHolder&quot;);
    }
}
</code></pre>
<h2 id="实现-mybatis-cache-接口用于自定义缓存为-redis">实现 MyBatis Cache 接口，用于自定义缓存为 Redis</h2>
<p>创建一个名为 RedisCache 的工具类，代码如下：</p>
<pre><code>import com.funtl.itoken.common.context.ApplicationContextHolder;
import org.apache.ibatis.cache.Cache;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.redis.core.RedisCallback;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.ValueOperations;

import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * Redis 缓存工具类
 * &lt;p&gt;Title: RedisCache&lt;/p&gt;
 * &lt;p&gt;Description: &lt;/p&gt;
 *
 * @author Lusifer
 * @version 1.0.0
 * @date 2018/8/13 6:03
 */
public class RedisCache implements Cache {
    private static final Logger logger = LoggerFactory.getLogger(RedisCache.class);

    private final ReadWriteLock readWriteLock = new ReentrantReadWriteLock();
    private final String id; // cache instance id
    private RedisTemplate redisTemplate;

    private static final long EXPIRE_TIME_IN_MINUTES = 30; // redis过期时间

    public RedisCache(String id) {
        if (id == null) {
            throw new IllegalArgumentException(&quot;Cache instances require an ID&quot;);
        }
        this.id = id;
    }

    @Override
    public String getId() {
        return id;
    }

    /**
     * Put query result to redis
     *
     * @param key
     * @param value
     */
    @Override
    public void putObject(Object key, Object value) {
        try {
            RedisTemplate redisTemplate = getRedisTemplate();
            ValueOperations opsForValue = redisTemplate.opsForValue();
            opsForValue.set(key, value, EXPIRE_TIME_IN_MINUTES, TimeUnit.MINUTES);
            logger.debug(&quot;Put query result to redis&quot;);
        } catch (Throwable t) {
            logger.error(&quot;Redis put failed&quot;, t);
        }
    }

    /**
     * Get cached query result from redis
     *
     * @param key
     * @return
     */
    @Override
    public Object getObject(Object key) {
        try {
            RedisTemplate redisTemplate = getRedisTemplate();
            ValueOperations opsForValue = redisTemplate.opsForValue();
            logger.debug(&quot;Get cached query result from redis&quot;);
//            System.out.println(&quot;****&quot; + opsForValue.get(key).toString());
            return opsForValue.get(key);
        } catch (Throwable t) {
            logger.error(&quot;Redis get failed, fail over to db&quot;, t);
            return null;
        }
    }

    /**
     * Remove cached query result from redis
     *
     * @param key
     * @return
     */
    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public Object removeObject(Object key) {
        try {
            RedisTemplate redisTemplate = getRedisTemplate();
            redisTemplate.delete(key);
            logger.debug(&quot;Remove cached query result from redis&quot;);
        } catch (Throwable t) {
            logger.error(&quot;Redis remove failed&quot;, t);
        }
        return null;
    }

    /**
     * Clears this cache instance
     */
    @Override
    public void clear() {
        RedisTemplate redisTemplate = getRedisTemplate();
        redisTemplate.execute((RedisCallback) connection -&gt; {
            connection.flushDb();
            return null;
        });
        logger.debug(&quot;Clear all the cached query result from redis&quot;);
    }

    /**
     * This method is not used
     *
     * @return
     */
    @Override
    public int getSize() {
        return 0;
    }

    @Override
    public ReadWriteLock getReadWriteLock() {
        return readWriteLock;
    }

    private RedisTemplate getRedisTemplate() {
        if (redisTemplate == null) {
            redisTemplate = ApplicationContextHolder.getBean(&quot;redisTemplate&quot;);
        }
        return redisTemplate;
    }
}
</code></pre>
<h2 id="mapper-接口中增加注解">Mapper 接口中增加注解</h2>
<p>在 Mapper 接口中增加注解，声明需要使用二级缓存</p>
<pre><code>import com.funtl.itoken.common.domain.TbSysUser;
import com.funtl.itoken.common.utils.RedisCache;
import org.apache.ibatis.annotations.CacheNamespace;
import tk.mybatis.mapper.MyMapper;

@CacheNamespace(implementation = RedisCache.class)
public interface TbSysUserMapper extends MyMapper&lt;TbSysUser&gt; {
}
</code></pre>

                          </div>
                        </div>
                        <div class="layout-post-social">
                          <div class="item reader">
                            <div id="/post/mybatis-redis-cache/" class="leancloud-visitors view"
                              data-flag-title="SpringBoot——Mybatis配置Redis二级缓存">
                              <span class="post-meta-item-text">阅读 </span>
                              <span class="leancloud-visitors-count"></span>
                            </div>
                          </div>
                        </div>

                        <div class="layout-post-navigation">
                          <div class="navigation-list">
                            
                            <div class="post-card row">
                              
                              <div class="card-content col-12">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://maodou38.github.io/swagger-use/" class="title">
                                      <h4>使用swagger接口文档引擎</h4>
                                    </a>
                                  </div>
                                  <div class="inner">
                                    <div class="abstract">
                                      
                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>上一篇</span></div>
                                  <div class="item">2020-03-27</div>
                                </div>
                              </div>
                              
                            </div>

                            <div class="post-card row">
                              
                              <div class="card-content col-12">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://maodou38.github.io/useful-urls/" class="title">
                                      <h4>各种资源地址整理</h4>
                                    </a>
                                  </div>
                                  <div class="inner">
                                    <div class="abstract">
                                      
                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>下一篇</span></div>
                                  <div class="item">2020-03-26</div>
                                </div>
                              </div>
                              
                            </div>

                            
                          </div>
                        </div>

                        <div class="layout-comments"></div>
                        
                      </div>
                    </div>

                    <div class="col-12 col-lg-2 d-none d-lg-block">
                      <div class="layout-post-sidebar">
                        <div class="layout-sidebar-item">
                          <ul class="markdownIt-TOC">
<li><a href="#%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98">一级缓存</a></li>
<li><a href="#%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98">二级缓存</a></li>
<li><a href="#%E5%BC%80%E5%90%AF-mybatis-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98">开启 MyBatis 二级缓存</a></li>
<li><a href="#%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AE%9E%E7%8E%B0%E5%BA%8F%E5%88%97%E5%8C%96%E6%8E%A5%E5%8F%A3%E5%B9%B6%E5%A3%B0%E6%98%8E%E5%BA%8F%E5%88%97%E5%8F%B7">实体类实现序列化接口并声明序列号</a></li>
<li><a href="#idea-%E6%8F%90%E7%A4%BA%E7%94%9F%E6%88%90%E5%BA%8F%E5%88%97%E5%8F%B7">IDEA 提示生成序列号</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E7%B1%BB">创建相关工具类</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0-spring-applicationcontextaware-%E6%8E%A5%E5%8F%A3%E7%94%A8%E4%BA%8E%E6%89%8B%E5%8A%A8%E6%B3%A8%E5%85%A5-bean">实现 Spring ApplicationContextAware 接口，用于手动注入 Bean</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0-mybatis-cache-%E6%8E%A5%E5%8F%A3%E7%94%A8%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%AD%98%E4%B8%BA-redis">实现 MyBatis Cache 接口，用于自定义缓存为 Redis</a></li>
<li><a href="#mapper-%E6%8E%A5%E5%8F%A3%E4%B8%AD%E5%A2%9E%E5%8A%A0%E6%B3%A8%E8%A7%A3">Mapper 接口中增加注解</a></li>
</ul>
</li>
</ul>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="layout-totop d-none"><i class="fa fa-angle-up" aria-hidden="true"></i></div>

    	<div class="layout-footer">

		<div class="container">
			<div class="row justify-content-lg-center">
				<div class="col-12 col-lg-9">
					<div class="footer">
						<div class="row">
							<div class="col-12 col-md-9">
								<div class="footer-copy">
									
									Powered by <a href="https://github.com/maodou38">randing</a>
									<div class="footer-icp d-none d-sm-inline-block">
										<span class="px-2">⋅</span>
										
									</div>
								</div>
							</div>
							<div class="col-sm-3 d-none d-md-block">
								<div class="footer-links">
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script type="text/javascript" src='https://maodou38.github.io/media/scripts/main.js'></script>
	

  </div>
</body>

</html>